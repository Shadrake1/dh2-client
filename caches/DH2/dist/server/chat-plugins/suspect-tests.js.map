{
  "version": 3,
  "sources": ["../../../server/chat-plugins/suspect-tests.ts"],
  "sourcesContent": ["import {Utils} from '../../lib';\r\nimport {FS} from '../../lib/fs';\r\n\r\nconst SUSPECTS_FILE = 'config/suspects.json';\r\n\r\ninterface SuspectTest {\r\n\ttier: string;\r\n\tsuspect: string;\r\n\tdate: string;\r\n\turl: string;\r\n}\r\n\r\ninterface SuspectsFile {\r\n\twhitelist: string[];\r\n\tsuspects: {[format: string]: SuspectTest};\r\n}\r\n\r\nexport let suspectTests: SuspectsFile = JSON.parse(FS(SUSPECTS_FILE).readIfExistsSync() || \"{}\");\r\n\r\nfunction saveSuspectTests() {\r\n\tFS(SUSPECTS_FILE).writeUpdate(() => JSON.stringify(suspectTests));\r\n}\r\n\r\nconst defaults: SuspectsFile = {\r\n\twhitelist: [],\r\n\tsuspects: {},\r\n};\r\n\r\nif (!suspectTests.whitelist && !suspectTests.suspects) {\r\n\tconst suspects = {...suspectTests} as unknown as {[format: string]: SuspectTest};\r\n\tsuspectTests = {...defaults, suspects};\r\n\tsaveSuspectTests();\r\n}\r\n\r\nfunction checkPermissions(context: Chat.CommandContext) {\r\n\tconst user = context.user;\r\n\tif (suspectTests.whitelist?.includes(user.id)) return true;\r\n\tcontext.checkCan('gdeclare');\r\n}\r\n\r\nexport const commands: Chat.ChatCommands = {\r\n\tsuspect: 'suspects',\r\n\tsuspects: {\r\n\t\t''(target, room, user) {\r\n\t\t\tconst suspects = suspectTests.suspects;\r\n\t\t\tif (!Object.keys(suspects).length) {\r\n\t\t\t\tthrow new Chat.ErrorMessage(\"There are no suspect tests running.\");\r\n\t\t\t}\r\n\t\t\tif (!this.runBroadcast()) return;\r\n\r\n\t\t\tlet buffer = '<strong>Suspect tests currently running:</strong>';\r\n\t\t\tfor (const i of Object.keys(suspects)) {\r\n\t\t\t\tconst test = suspects[i];\r\n\t\t\t\tbuffer += '<br />';\r\n\t\t\t\tbuffer += `${Utils.escapeHTML(test.tier)}: <a href=\"${test.url}\">${Utils.escapeHTML(test.suspect)}</a> (${test.date})`;\r\n\t\t\t}\r\n\t\t\treturn this.sendReplyBox(buffer);\r\n\t\t},\r\n\r\n\t\tedit: 'add',\r\n\t\tadd(target, room, user) {\r\n\t\t\tcheckPermissions(this);\r\n\r\n\t\t\tconst [tier, suspect, date, url, coil] = target.split(',');\r\n\t\t\tif (!(tier && suspect && date && url)) {\r\n\t\t\t\treturn this.parse('/help suspects');\r\n\t\t\t}\r\n\r\n\t\t\tconst format = Dex.formats.get(tier);\r\n\t\t\tif (!format.exists) throw new Chat.ErrorMessage(`\"${tier}\" is not a valid tier.`);\r\n\r\n\t\t\tconst suspectString = suspect.trim();\r\n\r\n\t\t\tconst [month, day] = date.trim().split(date.includes('-') ? '-' : '/');\r\n\t\t\tconst isValidDate = /[0-1]?[0-9]/.test(month) && /[0-3]?[0-9]/.test(day);\r\n\t\t\tif (!isValidDate) throw new Chat.ErrorMessage(\"Dates must be in the format MM/DD.\");\r\n\t\t\tconst dateActual = `${month}/${day}`;\r\n\r\n\t\t\tconst urlActual = url.trim();\r\n\t\t\tif (!/^https:\\/\\/www\\.smogon\\.com\\/forums\\/(threads|posts)\\//.test(urlActual)) {\r\n\t\t\t\tthrow new Chat.ErrorMessage(\"Suspect test URLs must be Smogon threads or posts.\");\r\n\t\t\t}\r\n\r\n\t\t\tthis.privateGlobalModAction(`${user.name} ${suspectTests.suspects[format.id] ? \"edited the\" : \"added a\"} ${format.name} suspect test.`);\r\n\t\t\tthis.globalModlog('SUSPECTTEST', null, `${suspectTests.suspects[format.id] ? \"edited\" : \"added\"} ${format.name}`);\r\n\r\n\t\t\tsuspectTests.suspects[format.id] = {\r\n\t\t\t\ttier: format.name,\r\n\t\t\t\tsuspect: suspectString,\r\n\t\t\t\tdate: dateActual,\r\n\t\t\t\turl: urlActual,\r\n\t\t\t};\r\n\t\t\tsaveSuspectTests();\r\n\t\t\tthis.sendReply(`Added a suspect test notice for ${suspectString} in ${format.name}.`);\r\n\t\t\tif (coil) {\r\n\t\t\t\tthis.parse(`/suspects setcoil ${format.id},${coil}`);\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tend: 'remove',\r\n\t\tdelete: 'remove',\r\n\t\tremove(target, room, user) {\r\n\t\t\tcheckPermissions(this);\r\n\r\n\t\t\tconst format = toID(target);\r\n\t\t\tconst test = suspectTests.suspects[format];\r\n\t\t\tif (!test) return this.errorReply(`There is no suspect test for '${target}'. Check spelling?`);\r\n\r\n\t\t\tthis.privateGlobalModAction(`${user.name} removed the ${test.tier} suspect test.`);\r\n\t\t\tthis.globalModlog('SUSPECTTEST', null, `removed ${test.tier}`);\r\n\r\n\t\t\tdelete suspectTests.suspects[format];\r\n\t\t\tsaveSuspectTests();\r\n\t\t\tthis.sendReply(`Removed a suspect test notice for ${test.suspect} in ${test.tier}.`);\r\n\t\t\tthis.sendReply(`Remember to remove COIL settings with /suspects deletecoil if you had them enabled.`);\r\n\t\t},\r\n\r\n\t\twhitelist(target, room, user) {\r\n\t\t\tthis.checkCan('gdeclare');\r\n\r\n\t\t\tconst userid = toID(target);\r\n\r\n\t\t\tif (!userid || userid.length > 18) {\r\n\t\t\t\tif (suspectTests.whitelist.length) {\r\n\t\t\t\t\tthis.sendReplyBox(`Current users with /suspects access: <username>${suspectTests.whitelist.join('</username>, <username>')}</username>`);\r\n\t\t\t\t}\r\n\t\t\t\treturn this.parse(`/help suspects`);\r\n\t\t\t}\r\n\r\n\t\t\tif (suspectTests.whitelist.includes(userid)) {\r\n\t\t\t\tthrow new Chat.ErrorMessage(`${userid} is already whitelisted to add suspect tests.`);\r\n\t\t\t}\r\n\r\n\t\t\tthis.privateGlobalModAction(`${user.name} whitelisted ${userid} to add suspect tests.`);\r\n\t\t\tthis.globalModlog('SUSPECTTEST', null, `whitelisted ${userid}`);\r\n\r\n\t\t\tsuspectTests.whitelist.push(userid);\r\n\t\t\tsaveSuspectTests();\r\n\t\t},\r\n\r\n\t\tunwhitelist(target, room, user) {\r\n\t\t\tthis.checkCan('gdeclare');\r\n\r\n\t\t\tconst userid = toID(target);\r\n\r\n\t\t\tif (!userid || userid.length > 18) {\r\n\t\t\t\treturn this.parse(`/help suspects`);\r\n\t\t\t}\r\n\r\n\t\t\tconst index = suspectTests.whitelist.indexOf(userid);\r\n\r\n\t\t\tif (index < 0) {\r\n\t\t\t\tthrow new Chat.ErrorMessage(`${userid} is not whitelisted to add suspect tests.`);\r\n\t\t\t}\r\n\r\n\t\t\tthis.privateGlobalModAction(`${user.name} unwhitelisted ${userid} from adding suspect tests.`);\r\n\t\t\tthis.globalModlog('SUSPECTTEST', null, `unwhitelisted ${userid}`);\r\n\r\n\t\t\tsuspectTests.whitelist.splice(index, 1);\r\n\t\t\tsaveSuspectTests();\r\n\t\t},\r\n\r\n\t\thelp() {\r\n\t\t\treturn this.parse('/help suspects');\r\n\t\t},\r\n\r\n\t\tdeletecoil: 'setcoil',\r\n\t\tsc: 'setcoil',\r\n\t\tdc: 'setcoil',\r\n\t\tasync setcoil(target, room, user, connection, cmd) {\r\n\t\t\tcheckPermissions(this);\r\n\t\t\tif (!toID(target)) {\r\n\t\t\t\treturn this.parse(`/help ${cmd}`);\r\n\t\t\t}\r\n\t\t\tconst [formatid, source] = this.splitOne(target).map(toID);\r\n\t\t\tlet bVal: number | undefined = parseFloat(source);\r\n\t\t\tif (cmd.startsWith('d')) {\r\n\t\t\t\tbVal = undefined;\r\n\t\t\t} else if (!source || isNaN(bVal) || bVal < 1) {\r\n\t\t\t\treturn this.errorReply(`Specify a valid COIL B value.`);\r\n\t\t\t}\r\n\t\t\tif (!formatid || !Dex.formats.get(formatid).exists) {\r\n\t\t\t\treturn this.errorReply(`Specify a valid format to set COIL for.`);\r\n\t\t\t}\r\n\t\t\tthis.sendReply(`Updating...`);\r\n\t\t\tconst [res, error] = await LoginServer.request('updatecoil', {\r\n\t\t\t\tformat: formatid,\r\n\t\t\t\tcoil_b: bVal,\r\n\t\t\t});\r\n\t\t\tif (error) {\r\n\t\t\t\treturn this.errorReply(error.message);\r\n\t\t\t}\r\n\t\t\tif (!res || res.actionerror) {\r\n\t\t\t\treturn this.errorReply(res?.actionerror || \"The loginserver is currently disabled.\");\r\n\t\t\t}\r\n\t\t\tthis.globalModlog(`${source ? 'SET' : 'REMOVE'}COIL`, null, `${formatid}${bVal ? ` to ${bVal}` : \"\"}`);\r\n\t\t\tthis.addGlobalModAction(\r\n\t\t\t\t`${user.name} ${bVal ? `set COIL for ${formatid} to ${bVal}` : `removed COIL values for ${formatid}`}`\r\n\t\t\t);\r\n\t\t\tif (source) {\r\n\t\t\t\treturn this.sendReply(`COIL B value for ${formatid} set to ${bVal}`);\r\n\t\t\t} else {\r\n\t\t\t\treturn this.sendReply(`Removed COIL for ${formatid}.`);\r\n\t\t\t}\r\n\t\t},\r\n\t\tsetcoilhelp: [\r\n\t\t\t`/suspects setcoil OR /suspects sc [formatid], [B value] - Activate COIL ranking for the given [formatid] with the given [B value].`,\r\n\t\t\t`Requires: suspect whitelist &`,\r\n\t\t],\r\n\t},\r\n\r\n\tsuspectshelp() {\r\n\t\tthis.sendReplyBox(\r\n\t\t\t`Commands to manage suspect tests:<br />` +\r\n\t\t\t`<code>/suspects</code>: displays currently running suspect tests.<br />` +\r\n\t\t\t`<code>/suspects add [tier], [suspect], [date], [link]</code>: adds a suspect test. Date in the format MM/DD. Requires: &<br />` +\r\n\t\t\t`<code>/suspects remove [tier]</code>: deletes a suspect test. Requires: &<br />` +\r\n\t\t\t`<code>/suspects whitelist [username]</code>: allows [username] to add suspect tests. Requires: &<br />` +\r\n\t\t\t`<code>/suspects unwhitelist [username]</code>: disallows [username] from adding suspect tests. Requires: &<br />` +\r\n\t\t\t`<code>/suspects setcoil OR /suspects sc [formatid], [B value]</code>: Activate COIL ranking for the given [formatid] with the given [B value].` +\r\n\t\t\t`Requires: suspect whitelist &`\r\n\t\t);\r\n\t},\r\n};\r\n"],
  "mappings": "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",
  "names": []
}
